<section id="widget-grid" data-ng-controller="Controller">
	<div class="row">
		<article class="col-xs-12 col-sm-6 col-md-4 col-lg-4">
			<div class="jarviswidget jarviswidget-color-teal">
				<header>
					<span class="widget-icon"><i class="fa fa-google"></i></span>
					<h2>Update Feed Product</h2>
				</header>
				<div>
					<div class="widget-body">
                        <form class="form-inline">
                            <div class="form-group">
                                <label class="sr-only" for="mpn">MPN</label>
                                <input type="search" class="form-control" id="mpn" placeholder="Custom MPN" ng-model="mpn">
                            </div>
                            <button type="submit" class="btn btn-primary" ng-click="search()">Search</button>
                        </form>
					</div>
				</div>
			</div>
		</article>
	</div>

    <div class="row" ng-show="products != null">
        <article class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <div class="jarviswidget jarviswidget-color-teal">
                <header>
                    <span class="widget-icon"><i class="fa fa-google"></i></span>
                    <h2>Search Results</h2>
                    <div class="widget-toolbar">
                        <div class="btn-group">
                            <button class="btn dropdown-toggle btn-xs btn-warning" data-toggle="dropdown">
                                <i class="fa fa-copy"></i>&nbsp; Bulk Actions <i class="fa fa-caret-down"></i>
                            </button>
                            <ul class="dropdown-menu pull-right">
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('price', 'Price')"><i class="fa fa-fw fa-dollar"></i> Update Price</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('category', 'Category')"><i class="fa fa-fw fa-info"></i> Update Category</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('custom_label0', 'Custom Label 0')"><i class="fa fa-fw fa-info"></i> Update Custom Label 0</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('custom_label1', 'Custom Label 1')"><i class="fa fa-fw fa-info"></i> Update Custom Label 1</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('custom_label2', 'Custom Label 2')"><i class="fa fa-fw fa-info"></i> Update Custom Label 2</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('custom_label3', 'Custom Label 3')"><i class="fa fa-fw fa-info"></i> Update Custom Label 3</a>
                                </li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="updateMultiple('custom_label4', 'Custom Label 4')"><i class="fa fa-fw fa-info"></i> Update Custom Label 4</a>
                                </li>
                                <li class="divider"></li>
                                <li>
                                    <a href="javascript:void(0);" ng-click="destroyMultiple()"><i class="fa fa-fw fa-times-circle"></i> Delete All</a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </header>
                <div>
                    <div class="widget-body">
                        <p ng-hide="products.length">No matching products.</p>
                        <accordion close-others="false">
                            <accordion-group ng-repeat="p in products" is-open="$first">
                                <accordion-heading>
                                    <strong>{{p.title}}</strong>
                                </accordion-heading>
                                <div class="panel-body">
                                    <form>
                                        <div class="form-group">
                                            <label for="id{{$index}}">Item ID</label>
                                            <input type="text" class="form-control" id="id{{$index}}" readonly ng-model="p.id">
                                        </div>
                                        <div class="form-group">
                                            <label for="mpn{{$index}}">MPN</label>
                                            <input type="text" class="form-control" id="mpn{{$index}}" placeholder="MPN" ng-model="p.mpn" maxlength="70">
                                        </div>
                                        <div class="form-group">
                                            <label for="brand{{$index}}">Brand</label>
                                            <input type="text" class="form-control" id="brand{{$index}}" placeholder="Brand" ng-model="p.brand" maxlength="70">
                                        </div>
                                        <div class="form-group">
                                            <label for="title{{$index}}">Title</label>
                                            <input type="text" class="form-control" id="title{{$index}}" placeholder="Title" ng-model="p.title" maxlength="150">
                                        </div>
                                        <div class="form-group">
                                            <label for="description{{$index}}">Description</label>
                                            <textarea class="form-control" rows="5" id="description{{$index}}" placeholder="Description" ng-model="p.description" maxlength="5000"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="link{{$index}}">Link</label>
                                            <input type="text" class="form-control" id="link{{$index}}" placeholder="Link" ng-model="p.link" maxlength="2000">
                                        </div>
                                        <div class="form-group">
                                            <label for="link{{$index}}">Image Link</label>
                                            <input type="text" class="form-control" id="image_link{{$index}}" placeholder="Image Link" ng-model="p.image_link" maxlength="2000">
                                        </div>
                                        <div class="form-group">
                                            <label for="price{{$index}}">Price</label>
                                            <input type="text" class="form-control" id="price{{$index}}" placeholder="Price" ng-model="p.price">
                                        </div>
                                        <div class="form-group">
                                            <label for="shipping{{$index}}">Shipping</label>
                                            <input type="text" class="form-control" id="shipping{{$index}}" placeholder="Shipping" ng-model="p.shipping">
                                        </div>
                                        <div class="form-group">
                                            <label for="item_condition{{$index}}">Condition</label>
                                            <select class="form-control" id="item_condition{{$index}}" ng-model="p.item_condition">
                                                <option value="new">New</option>
                                                <option value="refurbished">Refurbished</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="availability{{$index}}">Availability</label>
                                            <select class="form-control" id="availability{{$index}}" ng-model="p.availability">
                                                <option value="in stock">In Stock</option>
                                                <option value="out of stock">Out of Stock</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="category{{$index}}">Category</label>
                                            <input type="text" class="form-control" id="category{{$index}}" placeholder="Category" ng-model="p.category" maxlength="2500">
                                        </div>
                                        <div class="form-group">
                                            <label for="custom_label0{{$index}}">Custom Label 0</label>
                                            <input type="text" class="form-control" id="custom_label0{{$index}}" placeholder="Custom Label 0" ng-model="p.custom_label0" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="custom_label1{{$index}}">Custom Label 1</label>
                                            <input type="text" class="form-control" id="custom_label1{{$index}}" placeholder="Custom Label 1" ng-model="p.custom_label1" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="custom_label2{{$index}}">Custom Label 2</label>
                                            <input type="text" class="form-control" id="custom_label2{{$index}}" placeholder="Custom Label 2" ng-model="p.custom_label2" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="custom_label3{{$index}}">Custom Label 3</label>
                                            <input type="text" class="form-control" id="custom_label3{{$index}}" placeholder="Custom Label 3" ng-model="p.custom_label3" maxlength="100">
                                        </div>
                                        <div class="form-group">
                                            <label for="custom_label4{{$index}}">Custom Label 4</label>
                                            <input type="text" class="form-control" id="custom_label4{{$index}}" placeholder="Custom Label 4" ng-model="p.custom_label4" maxlength="100">
                                        </div>
                                        <button type="button" class="btn btn-success" ng-click="update(p)">Update</button>&nbsp;&nbsp;
                                        <button type="button" class="btn btn-danger" ng-click="destroy(p.id, $index)">Delete</button>
                                    </form>
                                </div>
                            </accordion-group>
                        </accordion>
                    </div>
                </div>
            </div>
        </article>
    </div>
</section>

<script type="text/javascript">
    pageSetUp();

    function Controller ($scope, $http)
    {
        $scope.products = null;
        
        $scope.search = function()
        {
            $http.get('/api/google_feed/search/' + $scope.mpn)
                .success(function (data)
                {
                    $scope.products = data;
                    if (!$scope.products) $scope.products = [];
                }).error(function (data)
                {
                    $scope.products = null;
                    $scope.$popError('Error while searching for products');
                });
        };

        $scope.destroy = function(id, index)
        {
            if (!confirm('Are you sure you want to delete this product?'))
                return;

            $http.delete('/api/google_feed/destroy/' + id)
                .success(function (data)
                {
                    if (data.success)
                    {
                        $scope.products.splice(index, 1);
                        $scope.$popOk('Product deleted successfully');
                    }
                    else $scope.$popError('Error while deleting product', data);
                }).error(function (data)
                {
                    $scope.$popError('Error while deleting product', data);
                });
        };

        $scope.destroyMultiple = function()
        {
            if (!$scope.products) return;

            if (!confirm('Are you sure you want to delete all products in this page?'))
                return;

            var ids = [];
            for (var i = 0; i < $scope.products.length; i++)
                ids.push($scope.products[i].id);

            $http.post('/api/google_feed/destroy_multiple', {ids: ids})
                    .success(function (data)
                    {
                        if (data.success)
                        {
                            $scope.products = null;
                            $scope.$popOk('Products deleted successfully');
                        }
                        else $scope.$popError('Error while deleting product', data);
                    }).error(function (data)
            {
                $scope.$popError('Error while deleting product', data);
            });
        };

        $scope.update = function(product)
        {
            $http.put('/api/google_feed/update/' + product.id, product)
                .success(function (data)
                {
                    if (data.success) $scope.$popOk('Product updated successfully');
                    else $scope.$popError('Error while updating product', data);
                }).error(function (data)
                {
                    $scope.$popError('Error while updating product', data);
                });
        };

        $scope.updateMultiple = function(field, label)
        {
            if (!$scope.products) return;

            var value = prompt('Enter new ' + label, $scope.products[0][field]);

            if (!confirm('Are you sure you want to update all products in this page?'))
                return;

            var ids = [];

            if ($scope.products)
                for (var i = 0; i < $scope.products.length; i++)
                    ids.push($scope.products[i].id);

            $http.post('/api/google_feed/update_multiple', {ids: ids, field: field, value: value})
                    .success(function (data)
                    {
                        if (data.success)
                        {
                            for (var i = 0; i < $scope.products.length; i++)
                                $scope.products[i][field] = value;

                            $scope.$popOk('Products updated successfully');
                        }
                        else $scope.$popError('Error while updating product', data);
                    }).error(function (data)
                    {
                        $scope.$popError('Error while updating product', data);
                    });
        };
    }
</script>
